<!DOCTYPE html>
<html lang="en">
<head>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "VisualArtwork",
          "@id": "https://guestbook.im/#content",
          "url": "https://guestbook.im",
          "name": "The Guestbook",
          "description": "A digital monument and tutorial for the old-school web guestbook, preserved by unearth.im.",
          "artMedium": "Interactive Web Tutorial",
          "artForm": "Digital Monument",
          "inLanguage": "en-US",
          "datePublished": "2024-12-01",
          "publisher": { "@id": "https://unearth.im/#organization" },
          "isPartOf": { "@id": "https://guestbook.im/#website" },
          "author": [
            { "@id": "https://josiest.com/#person" },
            { "@id": "https://felixvelas.co/#person" }
          ]
        },
        {
          "@type": "WebSite",
          "@id": "https://guestbook.im/#website",
          "url": "https://guestbook.im",
          "name": "guestbook.im",
          "publisher": { "@id": "https://unearth.im/#organization" }
        },
        {
          "@type": "Organization",
          "@id": "https://unearth.im/#organization",
          "name": "unearth.im",
          "url": "https://unearth.im",
          "logo": {
            "@type": "ImageObject",
            "url": "https://unearth.im/favicon-32x32.png"
          },
          "foundingDate": "2024",
          "sameAs": [
            "https://twitter.com/unearthim",
            "https://github.com/unearthim"
          ]
        },
        {
          "@type": "Person",
          "@id": "https://josiest.com/#person",
          "name": "Josie Jefferson",
          "url": "https://josiest.com",
          "jobTitle": "Digital Archaeologist & Trust Architect",
          "affiliation": { "@id": "https://unearth.im/#organization" },
          "sameAs": ["https://notjojo.im"]
        },
        {
          "@type": "Person",
          "@id": "https://felixvelas.co/#person",
          "name": "Felix Velasco",
          "url": "https://felixvelas.co",
          "jobTitle": "Trust Architect & Digital Archaeologist",
          "affiliation": { "@id": "https://unearth.im/#organization" },
          "sameAs": ["https://www.linkedin.com/in/felix-velasco-b793015"]
        }
      ]
    }
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO Meta Tags -->
    <title>The Guestbook</title>
    <meta name="description" content="A digital monument and tutorial for the old-school web guestbook, preserved by unearth.im.">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load retro font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'VT323', monospace;
            background-color: #f5f5dc; /* Parchment / Beige */
            color: #4a2c2a; /* Dark brown */
            font-size: 1.25rem; /* 20px */
            line-height: 1.6;
        }

        .site-container {
            display: flex;
            flex-direction: column; /* Mobile-first (stacked) */
            border: 4px outset #bdbab0;
            background-color: #e0dac0;
        }

        .sidebar {
            border-bottom: 4px outset #bdbab0;
            padding: 1rem;
        }

        .content-pane {
            padding: 1.5rem;
            width: 100%;
        }

        /* Responsive layout for desktop */
        @media (min-width: 768px) { /* md breakpoint */
            .site-container {
                flex-direction: row; /* Sidebar on left, content on right */
            }
            .sidebar {
                border-right: 4px outset #bdbab0;
                border-bottom: none;
                width: 300px;
                min-width: 300px;
            }
            .content-pane {
                height: 80vh; /* Set a height for scrolling */
                overflow-y: auto; /* Enable scrolling for content */
            }
        }
        
        a.nav-link {
            display: block;
            padding: 0.5rem 1rem;
            font-size: 1.5rem;
            color: #6a3a3a;
            border: 3px outset transparent;
            text-decoration: none;
        }
        
        a.nav-link:hover {
            background-color: #c0bca5;
        }
        
        a.nav-link.active {
            border-style: inset;
            background-color: #b0ad9a;
            font-weight: bold;
        }
        
        a.content-link {
            color: #a05a2f;
            text-decoration: underline;
        }
        a.content-link:hover {
            color: #6a3a3a;
        }

        /* Hide all pages by default */
        .page-content {
            display: none;
        }
        
        /* Show the active page */
        .page-content.active {
            display: block;
        }

        /* --- STYLES FOR GUESTBOOK --- */

        /* 90s-style outset/inset borders for a 3D feel */
        .retro-box {
            background-color: #e0dac0; /* A slightly darker beige */
            border: 4px outset #bdbab0;
            border-radius: 0;
            padding: 1.5rem;
        }
        
        /* Use a slightly different bg for the one inside the content pane */
        .content-pane .retro-box {
             background-color: #f0ebe0; /* Lighter beige */
        }

        .retro-input,
        .retro-textarea {
            border: 2px inset #bdbab0;
            background-color: #fafaeb;
            padding: 0.5rem;
            font-family: inherit;
            font-size: 1rem;
            width: 100%;
            color: #333;
        }
        
        .retro-input:focus,
        .retro-textarea:focus {
            outline: 2px solid #4a2c2a;
        }

        .retro-button {
            border: 3px outset #bdbab0;
            background-color: #c0bca5;
            padding: 0.5rem 1rem;
            font-weight: bold;
            cursor: pointer;
            color: #4a2c2a;
            font-size: 1.125rem;
        }
        
        .retro-button:active {
            border-style: inset;
            background-color: #b0ad9a;
        }
        
        /* Dashed divider for entries */
        .entry {
            border-bottom: 2px dashed #a05a2f; /* A coppery brown */
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        
        .entry-header {
            font-weight: bold;
            font-size: 1.25rem;
            color: #6a3a3a; /* Darker red-brown */
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        
        .entry-timestamp {
            font-size: 0.9rem;
            font-weight: normal;
            color: #5e5e5e;
        }
        
        .entry-message {
            margin-top: 0.5rem;
            white-space: pre-wrap; /* Preserves line breaks from textarea */
            word-wrap: break-word; /* Prevents long words from overflowing */
        }

        /* Loading/Error Message Box */
        #message-box {
            display: none; /* Hidden by default */
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem;
            background-color: #4a2c2a;
            color: #f5f5dc;
            border: 4px outset #bdbab0;
            z-index: 100;
            font-size: 1rem;
        }
        /* --- END OF GUESTBOOK STYLES --- */
    </style>
</head>
<body class="p-8 sm:p-12 md:p-16">

    <!-- This is the main 90s-style "window" -->
    <div class="site-container max-w-6xl mx-auto">
        
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <h2 class="text-3xl font-bold mb-4 p-2">The Monument</h2>
            <a href="#home" class="nav-link active" data-page="home">Home</a>
            <a href="#what-is" class="nav-link" data-page="what-is">What is a Guestbook?</a>
            <a href="#how-to" class="nav-link" data-page="how-to">Create Your Own</a>
            <a href="#guestbook" class="nav-link" data-page="guestbook">Our Guestbook</a>
            <a href="#about" class="nav-link" data-page="about">About This Project</a>
        </nav>
        
        <!-- Main Content Area -->
        <main class="content-pane">
            
            <!-- Page 1: Home -->
            <div id="page-home" class="page-content active">
                <h1 class="text-5xl font-bold mb-6">Welcome.</h1>
                <p class="mb-4">You've found a living monument to the "hand-built" web. This site is a celebration and a functional tutorial for one of the web's first social features: the <strong>guestbook</strong>.</p>
                <div class="p-4 retro-box" style="background-color: #fafaeb; border-style: inset; border-width: 2px;">
                    <h2 class="text-3xl font-bold mb-3">What is this?</h2>
                    <ul class="list-disc list-inside space-y-2">
                        <li>A <strong>philosophy</strong> on why these simple tools mattered.</li>
                        <li>A step-by-step <strong>guide</strong> to build your own.</li>
                        <li>A <strong>living example</strong> you can sign right now.</li>
                    </ul>
                    <p class="mt-4">
                        <!-- Responsive text that changes based on screen size -->
                        <span class="block md:hidden">Use the navigation above to explore.</span>
                        <span class="hidden md:block">Use the navigation on the left to explore.</span>
                    </p>
                </div>
            </div>
            
            <!-- Page 2: What is a Guestbook? -->
            <div id="page-what-is" class="page-content">
                <h1 class="text-4xl font-bold mb-6">What is a Guestbook?</h1>
                <h2 class="text-3xl font-bold mb-4">Part 1: The Philosophy</h2>
                <p class="mb-4">Remember guestbooks? Before "likes," "feeds," or "followers," there was the humble guestbook. It was the digital equivalent of a welcome mat and a handwritten log on the table of a bed-and-breakfast.</p>
                <p class="mb-4">It was a simple, chronological wall of "I was here," a quiet, asynchronous conversation between a creator and their visitors.</p>
                <p class="mb-4">Guestbooks were the original social media, but without the noise. They were about <strong>connection</strong>, not content. They were a landmark of the early, "hand-built" web, where every homepage was a digital home.</p>
                <p class="mb-4">This project is a <strong>Digital Monument</strong> to that idea. We are unearthing that simple, powerful connection and showing how its spirit can live on with modern, accessible tools.</p>
            </div>

            <!-- Page 3: Create Your Own -->
            <div id="page-how-to" class="page-content">
                <h1 class="text-4xl font-bold mb-6">Create Your Own</h1>
                <p class="mb-4">A monument needs a strong foundation. Ours stands on three pillars: The HTML, The Firebase Project, and The Security Rules.</p>
                <hr class="border-2 border-dashed border-[#a05a2f] my-6">

                <h2 class="text-3xl font-bold mb-4">Pillar 1: The HTML</h2>
                <p class="mb-4">This is the complete, self-contained HTML file. It's everything your visitors will see. Copy all the code from the <a href="guestbook-template.html" class="content-link" target="_blank">guestbook-template.html</a> file and save it as `index.html` on your computer.</p>

                <h2 class="text-3xl font-bold mb-4 mt-6">Pillar 2: The "Engine"</h2>
                <p class="mb-4">Our guestbook needs a place to store its entries. We'll use Firebase Firestore, a free, real-time database from Google.</p>
                <ol class="list-decimal list-inside space-y-2 mb-4">
                    <li><strong>Go to Firebase:</strong> Go to <a href="https://firebase.google.com/" class="content-link" target="_blank">firebase.google.com</a> and sign in.</li>
                    <li><strong>Create a Project:</strong> Click "Go to console" and "Add project." Give it a name (e.g., "My-Guestbook").</li>
                    <li><strong>Add a Web App:</strong> Inside your project, click the Web icon (<code>&lt;/&gt;</code>). Give it a nickname and click "Register app."</li>
                    <li><strong>Get Your Keys:</strong> Firebase will show you a JavaScript object called <code>firebaseConfig</code>. This is your key.</li>
                    <li><strong>Connect Your HTML:</strong> Copy this <em>entire</em> <code>firebaseConfig</code> object. Open your <code>index.html</code> file (from Pillar 1) and paste it directly into the <code>&lt;script&gt;</code> tag at the bottom, replacing the placeholder.</li>
                </ol>

                <h2 class="text-3xl font-bold mb-4 mt-6">Pillar 3: The "Rules"</h2>
                <p class="mb-4">This is the most important step. By default, your new database is locked down. We need to create a "bouncer" that only lets our guestbook read and write.</p>
                <ol class="list-decimal list-inside space-y-2 mb-4">
                    <li><strong>Go to Firestore:</strong> In your Firebase project, go to <strong>Build</strong> &gt; <strong>Firestore Database</strong>.</li>
                    <li><strong>Create Database:</strong> Click "Create database." Start in <strong>Test mode</strong>. This gives you 30 days before it locks down.</li>
                    <li><strong>Write Your Rules:</strong> After your database is made, click the <strong>Rules</strong> tab.</li>
                    <li>Delete <em>everything</em> in the editor and paste in these rules:</li>
                </ol>
                <pre class="retro-box p-4 text-sm" style="background-color: #fafaeb; border-style: inset; border-width: 2px; overflow-x: auto;">
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // This rule allows anyone signed in (even anonymously)
    // to read and create entries.
    match /guestbookEntries/{docId} {
      allow read, create: if request.auth != null;
    }
  }
}
                </pre>
                <p class="mt-4"><strong>Publish:</strong> Click the <strong>Publish</strong> button.</p>
                <hr class="border-2 border-dashed border-[#a05a2f] my-6">
                <p class="text-2xl font-bold">That's it. Your monument is complete.</p>
            </div>

            <!-- Page 4: Our Guestbook (MERGED CODE) -->
            <div id="page-guestbook" class="page-content">
                <h1 class="text-4xl font-bold mb-6">Sign Our Guestbook</h1>
                <p class="mb-4">This is a living example of the guestbook described in this monument. It's running the exact same code. Feel free to leave your mark!</p>
                
                <!-- HTML from guestbook.html, pasted directly -->
                <div class="retro-box">
                    <h1 class="text-4xl font-bold text-center mb-6 text-shadow">
                        ~~ Ye Olde Guestbook ~~
                    </h1>
            
                    <!-- Form for new entries -->
                    <form id="guestbook-form" class="mb-8">
                        <div class="mb-4">
                            <label for="name" class="block mb-2 text-lg">Your Name:</label>
                            <input type="text" id="name" class="retro-input" required maxlength="50">
                        </div>
                        
                        <div class="mb-4">
                            <label for="message" class="block mb-2 text-lg">Your Message:</label>
                            <textarea id="message" rows="4" class="retro-textarea" required maxlength="500"></textarea>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="retro-button">
                                Sign the Book!
                            </button>
                        </div>
                    </form>
                    
                    <!-- Divider -->
                    <hr class="border-2 border-dashed border-[#a05a2f] my-8">
                    
                    <!-- Display area for entries -->
                    <h2 class="text-3xl font-bold text-center mb-6">What Folks Have Said:</h2>
                    <div id="entries-container">
                        <p class="text-center">Loading entries...</p>
                    </div>
                </div>
                <!-- End of pasted HTML -->
            </div>

            <!-- Page 5: About This Project -->
            <div id="page-about" class="page-content">
                <h1 class="text-4xl font-bold mb-6">About This Monument</h1>
                <p class="mb-4">This project is a "Digital Monument," a "proof-of-work" concept from the <a href="https://unearth.im" class="content-link" target="_blank">unearth.im</a> foundry.</p>
                <p class="mb-4">The goal is to unearth the stories and philosophies of the "hand-built" webâ€”not just to remember them, but to make them functional and accessible for a new generation.</p>
                <p class="mb-4">The guestbook represents a time when the web was a collection of digital homes, and discovery was an act of personal connection. By preserving this tool, we preserve that story.</p>
                <p class="mb-4">It is, in short, <strong>story, grounded.</strong></p>
            </div>
            
        </main>
        
    </div>
    
    <!-- Footer -->
    <footer class="text-center text-lg mt-8 text-[#6a3a3a]">
        <small>
            a <b><a href="https://sentientification.com" class="content-link" target="_blank" rel="noopener noreferrer">liminal mind meld</a></b> collaboration: digital monument by <b><a href="https://unearth.im" class="content-link" target="_blank" rel="noopener noreferrer">unearth.im</a></b> | <b><a href="https://archaeobytology.org" class="content-link" target="_blank" rel="noopener noreferrer">archive & anvil</a></b>
        </small>
    </footer>

    <!-- Message box for errors/loading (from guestbook.html) -->
    <div id="message-box"></div>

    <!-- 
        PAGE NAVIGATION SCRIPT 
        This script handles showing/hiding pages.
    -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const navLinks = document.querySelectorAll('a.nav-link');
            const pages = document.querySelectorAll('.page-content');
            const contentPane = document.querySelector('.content-pane');
            let guestbookInitialized = false; // Flag to run init only once

            function showPage(pageId) {
                // Hide all pages
                pages.forEach(page => {
                    page.classList.remove('active');
                });
                
                // Show the target page
                const targetPage = document.getElementById(`page-${pageId}`);
                if (targetPage) {
                    targetPage.classList.add('active');
                }
                
                // Update active state for nav links
                navLinks.forEach(link => {
                    if (link.dataset.page === pageId) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });
                
                // Scroll content to top
                if(contentPane) {
                    contentPane.scrollTop = 0;
                }

                // If we are showing the guestbook page and it hasn't been initialized, run it.
                if (pageId === 'guestbook' && !guestbookInitialized) {
                    console.log("Initializing guestbook app for the first time...");
                    if (typeof window.initGuestbookApp === 'function') {
                        window.initGuestbookApp();
                        guestbookInitialized = true; // Set flag so it only runs once
                    } else {
                        console.error("Guestbook initialization function not found! Make sure it's defined in the module script.");
                    }
                }
            }

            // Handle nav link clicks
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.dataset.page;
                    showPage(pageId);
                    // Update URL hash for bookmarking/navigation
                    history.pushState(null, '', `#${pageId}`);
                });
            });

            // Handle browser back/forward buttons
            window.addEventListener('popstate', () => {
                const hash = window.location.hash.substring(1) || 'home';
                showPage(hash);
            });

            // Show initial page based on URL hash (or default to 'home')
            const initialHash = window.location.hash.substring(1) || 'home';
            showPage(initialHash);
        });
    </script>

    <!-- 
        GUESTBOOK APP SCRIPT (MERGED FROM GUESTBOOK.HTML)
        This script now runs in the main document.
    -->
    <script type="module">
        // Import Firebase modules
        // ** NOTE: Using 12.6.0 to match your other public file **
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // --- Global Variables (will be set in init) ---
        let db, auth, userId;
        let guestbookForm, nameInput, messageInput, entriesContainer, messageBox;
        
        // --- FIXED: Hardcode config for public site ---
        const firebaseConfig = {
          apiKey: "AIzaSyAEU3QcCzu4ZmwJpHhogu1hMpyRp2swUz8",
          authDomain: "jojo-4b593.firebaseapp.com",
          projectId: "jojo-4b593",
          storageBucket: "jojo-4b593.firebasestorage.app",
          messagingSenderId: "353107431611",
          appId: "1:353107431611:web:cdfbe88f704b137f44599e",
          measurementId: "G-76MYKY7PWC"
        };
        
        // --- FIXED: Set simple public collection path ---
        const GUESTBOOK_COLLECTION_PATH = `guestbookEntries`;


        // --- Helper Functions ---
        
        /**
         * Shows a message in the message box.
         * @param {string} text - The message to display.
         * @param {number} [duration=3000] - How long to show the message (in ms).
         */
        function showMessage(text, duration = 3000) {
            if (!messageBox) return; // Guard clause
            messageBox.textContent = text;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, duration);
        }

        /**
         * Formats a Firestore timestamp into a readable string.
         * @param {object} timestamp - Firestore timestamp object (or null).
         * @returns {string} - Formatted date/time string.
         */
        function formatTimestamp(timestamp) {
            if (timestamp && timestamp.seconds) {
                return new Date(timestamp.seconds * 1000).toLocaleString();
            }
            return 'Just now';
        }

        // --- Core Functions ---

        /**
         * Adds a new entry to the Firestore guestbook.
         * @param {Event} e - The form submit event.
         */
        async function addEntry(e) {
            e.preventDefault(); // Prevent default form submission
            
            if (!db || !userId) {
                showMessage("Not connected to database. Please wait.");
                return;
            }

            const name = nameInput.value.trim();
            const message = messageInput.value.trim();

            if (!name || !message) {
                showMessage("Please fill out both name and message!");
                return;
            }

            try {
                const guestbookCollection = collection(db, GUESTBOOK_COLLECTION_PATH);
                await addDoc(guestbookCollection, {
                    name: name,
                    message: message,
                    timestamp: serverTimestamp(),
                    ownerId: userId // Store who made the post
                });
                
                // Clear the form
                nameInput.value = '';
                messageInput.value = '';
                showMessage("Entry added!", 2000);

            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage("Error: Could not add entry.");
            }
        }

        /**
         * Loads guestbook entries from Firestore and displays them.
         */
        function loadGuestbook() {
            if (!db) {
                entriesContainer.innerHTML = '<p class="text-center">Error: Database not initialized.</p>';
                return;
            }

            const q = query(collection(db, GUESTBOOK_COLLECTION_PATH));
            
            onSnapshot(q, (querySnapshot) => {
                if (!entriesContainer) return; // Guard clause
                entriesContainer.innerHTML = ''; // Clear current entries
                
                if (querySnapshot.empty) {
                    entriesContainer.innerHTML = '<p class="text-center">Be the first to sign!</p>';
                    return;
                }

                // Get docs and sort them client-side by timestamp (newest first)
                const entries = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Sort by timestamp, handling potential nulls
                entries.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.seconds : 0;
                    const timeB = b.timestamp ? b.timestamp.seconds : 0;
                    return timeB - timeA; // Descending order
                });

                // Render sorted entries
                entries.forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'entry';

                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'entry-header';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = entry.name;
                    
                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'entry-timestamp';
                    timeSpan.textContent = formatTimestamp(entry.timestamp);
                    
                    headerDiv.appendChild(nameSpan);
                    headerDiv.appendChild(timeSpan);

                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'entry-message';
                    // Use textContent to prevent HTML injection
                    messageDiv.textContent = entry.message; 
                    
                    entryDiv.appendChild(headerDiv);
                    entryDiv.appendChild(messageDiv);
                    
                    entriesContainer.appendChild(entryDiv);
                });

            }, (error) => {
                console.error("Error loading guestbook: ", error);
                if(entriesContainer) {
                    entriesContainer.innerHTML = '<p class="text-center">Error loading entries. Check console.</p>';
                }
                showMessage("Error loading guestbook.");
            });
        }

        /**
         * Initializes the Firebase app and sets up auth/listeners.
         * This function is now exposed on the window and called by the nav script.
         */
        window.initGuestbookApp = async function() {
            
            // 1. Get references to all the UI elements
            guestbookForm = document.getElementById('guestbook-form');
            nameInput = document.getElementById('name');
            messageInput = document.getElementById('message');
            entriesContainer = document.getElementById('entries-container');
            messageBox = document.getElementById('message-box');

            // 2. Check if elements exist (in case of error)
            if (!guestbookForm || !entriesContainer || !messageBox) {
                console.error("Guestbook HTML elements not found!");
                if (entriesContainer) {
                    entriesContainer.innerHTML = '<p class="text-center">Error: Page elements not found.</p>';
                }
                return;
            }
            
            // 3. Check for Firebase config (it's hardcoded above)
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing or invalid.");
                entriesContainer.innerHTML = '<p class="text-center">Error: Firebase config is missing or invalid.</p>';
                return;
            }

            try {
                // 4. Initialize Firebase
                const app = initializeApp(firebaseConfig);
                const analytics = getAnalytics(app); // Include analytics
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Enable debug logging for Firestore
                setLogLevel('Debug');

                // 5. Set up auth state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in
                        userId = user.uid;
                        console.log("User signed in with UID:", userId);
                        // Once auth is ready, load the guestbook
                        loadGuestbook();
                    } else {
                        // User is signed out, attempt to sign in
                        try {
                            // --- FIXED: Only use anonymous sign-in ---
                            console.log("Signing in anonymously...");
                            await signInAnonymously(auth);
                            
                        } catch (authError) {
                            console.error("Auth Error: ", authError);
                            showMessage("Error: Could not authenticate.");
                        }
                    }
                });

                // 6. Attach form submit listener
                guestbookForm.addEventListener('submit', addEntry);

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                entriesContainer.innerHTML = '<p class="text-center">Fatal Error: Could not initialize app. Check console.</p>';
            }
        }
    </script>

</body>
</html>