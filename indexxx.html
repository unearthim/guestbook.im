<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- === 1. Primary Meta Tags (unearth.im Protocol v2.0) === -->
    <title>The `guestbook.im` Archive | A Digital Monument</title>
    <meta name="title" content="The `guestbook.im` Archive | A Digital Monument">
    <meta name="description" content="An interactive digital monument by unearth.im. Leave a fragment for the archive, a collective guestbook preserving the echoes of the digital past.">
    <meta name="keywords" content="digital monument, guestbook, digital archaeology, unearth.im, conceptual artifact, interactive art, collaborative storytelling, web 1.0, petribyte">
    <meta name="author" content="guestbook.im (An unearth.im Project)">
    <meta name="robots" content="index, follow">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="language" content="English">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://guestbook.im/" />
     
    <!-- === 2. Webmention Endpoint === -->
    <link rel="webmention" href="https://webmention.io/unearth.im/webmention" />

    <!-- === 3. Open Graph / Facebook === -->
    <meta property="og:type" content="website"> 
    <meta property="og:url" content="https://guestbook.im/">
    <meta property="og:title" content="The `guestbook.im` Archive | A Digital Monument">
    <meta property="og:description" content="An interactive digital monument by unearth.im. Leave a fragment for the archive, a collective guestbook preserving the echoes of the digital past.">
    <meta property="og:image" content="https://placehold.co/1200x630/F8F7F4/2E2E2E?text=guestbook.im&font=lora">
    <meta property="og:site_name" content="The `guestbook.im` Archive">

    <!-- === 4. Twitter Card === -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://guestbook.im/">
    <meta property="twitter:title" content="The `guestbook.im` Archive | A Digital Monument">
    <meta property="twitter:description" content="An interactive digital monument by unearth.im. Leave a fragment for the archive, a collective guestbook preserving the echoes of the digital past.">
    <meta property="twitter:image" content="https://placehold.co/1200x630/F8F7F4/2E2E2E?text=guestbook.im&font=lora">

    <!-- === 5. Favicons === -->
    <!-- Note: We would replace these with actual favicons for the project -->
    <link rel="icon" href="https://placehold.co/32x32/A95C3D/F8F7F4?text=G&font=lora" type="image/png">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/A95C3D/F8F7F4?text=G&font=lora">

    <!-- === 6. Brand Color Meta Tags (unearth.im Light Mode) === -->
    <meta name="theme-color" content="#F8F7F4">
    <meta name="msapplication-TileColor" content="#A95C3D">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (unearth.im Standard: Lora & Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        /* Applying unearth.im brand fonts */
        body {
            /* Lora is the default for narrative content */
            font-family: 'Lora', serif;
            /* Remove scrollbars */
            overflow: hidden;
            color: #2E2E2E;
            background-color: #F8F7F4;
        }
        
        .font-sans {
            /* Inter is for UI elements */
            font-family: 'Inter', sans-serif;
        }
        .font-serif {
            font-family: 'Lora', serif;
        }

        /* Custom animation for the fragments, using Burnt Sienna accent */
        @keyframes subtle-pulse {
            0%, 100% {
                opacity: 0.7;
                box-shadow: 0 0 3px 0px rgba(169, 92, 61, 0.5); /* unearth.im Primary Accent */
            }
            50% {
                opacity: 1;
                box-shadow: 0 0 6px 2px rgba(169, 92, 61, 0.7); /* unearth.im Primary Accent */
            }
        }
        
        .animate-subtle-pulse {
            animation: subtle-pulse 3s infinite ease-in-out;
        }

        /* Slow spin for the background compass */
        @keyframes spin-slow {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin-slow {
            animation: spin-slow 45s linear infinite;
        }
    </style>
</head>
<body class="bg-[#F8F7F4] text-[#2E2E2E]">

    <!-- Main App Container: This is the "canvas" -->
    <div id="app-container" class="relative w-screen h-screen overflow-hidden bg-[#F8F7F4] cursor-pointer">

        <!-- Central Visual Artifact: Compass Rose -->
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <svg class="w-2/3 h-2/3 md:w-1/2 md:h-1/2 text-gray-500 opacity-10 animate-spin-slow"
                 xmlns="http://www.w3.org/2000/svg"
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 22s-8-4-8-10V5l8-3 8 3v7c0 6-8 10-8 10z"></path>
                <path d="M12 2l-8 4v7c0 6 8 10 8 10s8-4 8-10V6L12 2z"></path>
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 15l-1.5-3 1.5-3 1.5 3z"></path>
                <path d="M12 12l3 1.5-3 1.5-3-1.5z"></path>
                <path d="M12 12l3-1.5-3-1.5-3 1.5z"></path>
                <path d="m10.5 9 1.5 3 1.5-3-1.5-3z"></path>
            </svg>
        </div>

        <!-- Parchment Background Texture -->
        <div class="absolute top-[10%] left-[15%] w-32 h-32 md:w-48 md:h-48 bg-gray-300/30 rounded-full blur-3xl opacity-70"></div>
        <div class="absolute bottom-[20%] right-[10%] w-64 h-64 md:w-96 md:h-96 bg-gray-300/20 rounded-full blur-3xl opacity-50"></div>
        
        <!-- Subtle paper layers -->
        <div class="absolute -bottom-1/4 left-1/2 w-[150%] h-1/2 bg-gray-200/40 rounded-full -translate-x-1/2 blur-2xl"></div>
        <div class="absolute -bottom-1/3 -left-1/4 w-full h-1/2 bg-gray-200/60 rounded-full blur-xl"></div>
        <div class="absolute -bottom-1/3 -right-1/4 w-full h-1/2 bg-gray-200/60 rounded-full blur-xl"></div>

        <!-- Title & Instructions -->
        <div class="absolute top-8 left-8 md:top-12 md:left-12 text-[#2E2E2E] select-none pointer-events-none z-10">
            <h1 class="font-serif text-3xl md:text-5xl font-bold">guestbook.im</h1>
            <p class="font-serif text-lg md:text-xl italic opacity-70 animate-pulse">Click anywhere on the parchment to leave your mark.</p>
            <p id="user-id-display" class="font-sans text-xs opacity-50 mt-4"></p>
        </div>

        <!-- Container for dynamically added "Fragments" -->
        <div id="fragment-container" class="absolute inset-0 w-full h-full z-0">
            <!-- Fragments will be added here by JS -->
        </div>

        <!-- Tooltip for hovering fragments -->
        <div id="tooltip" class="hidden absolute z-50 p-4 max-w-xs text-sm bg-white text-[#2E2E2E] rounded-lg shadow-xl pointer-events-none transition-opacity duration-150 border border-gray-200">
            <!-- Tooltip content added by JS -->
        </div>
    </div>

    <!-- Footer & Curator's Note Link -->
    <div class="absolute bottom-8 left-8 md:bottom-12 md:left-12 text-gray-500/90 text-sm font-serif select-none z-10">
        <p>
            A digital monument by 
            <a href="https://unearth.im" target="_blank" rel="noopener noreferrer" class="underline hover:text-[#A95C3D] transition-colors">unearth.im</a>
            |
            <button id="open-curator-note" class="underline hover:text-[#A95C3D] transition-colors">Curator's Note</button>
        </p>
    </div>

    <!-- Modal for leaving a fragment -->
    <div id="entry-modal" class="hidden fixed inset-0 z-40 bg-black/50 flex items-center justify-center p-4">
        <div id="modal-content" class="bg-[#F8F7F4]/90 backdrop-blur-md w-full max-w-md p-6 rounded-lg shadow-2xl border border-gray-300/70">
            <h2 class="font-serif text-2xl text-[#2E2E2E] mb-4">Inscribe Your Fragment</h2>
            <p class="font-serif text-gray-600 mb-4 text-base">Leave a thought, a memory, or a fragment for future archaeologists. (Max 150 chars)</p>
            <textarea id="echo-textarea"
                class="w-full h-24 p-3 font-serif bg-gray-100/50 text-[#2E2E2E] rounded-md border border-gray-400 focus:outline-none focus:ring-2 focus:ring-[#A95C3D]"
                maxlength="150"
                placeholder="I was here, I saw..."></textarea>
            <div class="flex justify-end gap-3 mt-4">
                <button id="close-modal" class="font-sans py-2 px-4 bg-gray-300/50 text-gray-700 rounded-lg hover:bg-gray-400/50 transition-colors">
                    Return to Archive
                </button>
                <button id="submit-echo" class="font-sans py-2 px-4 bg-[#A95C3D] text-white rounded-lg hover:bg-[#A95C3D]/90 transition-colors font-semibold w-36">
                    Inscribe Entry
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Curator's Note -->
    <div id="curator-note-modal" class="hidden fixed inset-0 z-40 bg-black/50 flex items-center justify-center p-4">
        <div id="curator-modal-content" class="bg-[#F8F7F4]/90 backdrop-blur-md w-full max-w-md p-6 rounded-lg shadow-2xl border border-gray-300/70">
            <h2 class="font-serif text-2xl text-[#2E2E2E] mb-4">Curator's Note</h2>
            <div class="text-gray-700 space-y-3 font-serif italic text-base md:text-lg">
                <p>This piece began with an artifact: the <span class="font-semibold not-italic text-[#2E2E2E]">"Guestbook,"</span> a conceptual fossil of the hand-built web.</p>
                <p>It was a <span class="font-semibold not-italic text-[#2E2E2E]">"Conceptual Petribyte"</span>—a ritual of connection based on human intentionality, not algorithms. (See: _Archaeobytology Theses_).</p>
                <p>This <span class="font-semibold not-italic text-[#2E2E2E]">"Digital Monument"</span> is our Anvil, forging that ancient ritual into a living form. (See: _Why We Build Digital Monuments_).</p>
                <p>It is a "story-rich landmark" where the narrative provenance comes not from a single author, but from the collective fragments left by every visitor.</p>
                <p class="font-semibold not-italic text-[#2E2E2E] mt-4 text-right">— unearth.im</p>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="close-curator-note" class="font-sans py-2 px-4 bg-gray-300/50 text-gray-700 rounded-lg hover:bg-gray-400/50 transition-colors">
                    Return
                </button>
            </div>
        </div>
    </div>

    <!-- Loading/Error Message Box -->
    <div id="message-box" class="hidden fixed bottom-4 right-4 z-50 bg-red-600 text-white p-4 rounded-lg shadow-lg font-sans">
        <!-- Message content added by JS -->
    </div>


   <script type="module">
        // Import Firebase modules (Updated to v12.5.0)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            onSnapshot, 
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // --- CONFIG & INITIALIZATION ---
        
        // *** THIS IS YOUR SECURE GEMINI PROXY URL ***
        const GEMINI_PROXY_URL = 'https://generatecontentproxy-ce7zb66hpq-uc.a.run.app';

        // *** YOUR REAL FIREBASE CONFIG (from your snippet) ***
        const firebaseConfig = {
            apiKey: "AIzaSyAEU3QcCzu4ZmwJpHhogu1hMpyRp2swUz8",
            authDomain: "jojo-4b593.firebaseapp.com",
            projectId: "jojo-4b593",
            storageBucket: "jojo-4b593.firebasestorage.app",
            messagingSenderId: "353107431611",
            appId: "1:353107431611:web:535175b216df8bc644599e",
            measurementId: "G-326975SXFX"
        };
        
        // We get the appId from the config object now
        const appId = firebaseConfig.appId;
        
        let app, auth, db, analytics;
        let currentUserId = null;
        let echoesCollectionPath = '';
        let echoesRef = null;
        let unsubscribeEchoes = null; 

        // State for managing click coordinates
        let tempCoords = { x: 0, y: 0 };

        // DOM Elements
        const appContainer = document.getElementById('app-container');
        const wispContainer = document.getElementById('wisp-container');
        const tooltip = document.getElementById('tooltip');
        const modal = document.getElementById('entry-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal');
        const submitEchoBtn = document.getElementById('submit-echo');
        const echoTextarea = document.getElementById('echo-textarea');
        const userIdDisplay = document.getElementById('user-id-display');
        const messageBox = document.getElementById('message-box');
        const artistStatementModal = document.getElementById('artist-statement-modal');
        const openArtistStatementBtn = document.getElementById('open-artist-statement');
        const closeArtistStatementBtn = document.getElementById('close-artist-statement');


        // --- FUNCTIONS ---

/**
 * Shows a message to the user (e.g., for errors)
 */
        function showMessage(message, isError = true) {
            console.log(isError ? "Error:" : "Success:", message);
            messageBox.textContent = message;
            messageBox.classList.toggle('bg-red-600', isError);
            messageBox.classList.toggle('bg-green-600', !isError);
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        /**
         * Calls the Gemini proxy to generate a title
         */
        async function generateTitle(echoText) {
            const systemPrompt = `You are the Curator of Avalon, a digital monument. A traveler has left an echo. Your task is to give this echo a short, mythical-sounding title (4 words max) that captures its essence. Do not add quotes.
Traveler's Echo: "${echoText}"
Title:`;

            console.log("Calling Gemini Proxy at:", GEMINI_PROXY_URL);

            try {
                const response = await fetch(GEMINI_PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: systemPrompt })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini Proxy Error:", errorData);
                    throw new Error(errorData.error || "Failed to generate title.");
                }

                const data = await response.json();
                console.log("Gemini Response:", data);
                const title = data.text.replace(/"/g, '').trim();
                return title || "An Echo in the Mist";

            } catch (error) {
                console.error("Failed to fetch from Gemini proxy:", error);
                return "An Echo in the Mist";
            }
        }

        /**
         * Renders a single echo (wisp) on the screen.
         */
        function renderEcho(doc) {
            try {
                const data = doc.data();
                if (data.x === undefined || data.y === undefined) return;

                const wisp = document.createElement('div');
                wisp.className = 'absolute w-2.5 h-2.5 bg-cyan-300/70 rounded-full shadow-lg animate-subtle-pulse cursor-pointer transform -translate-x-1/2 -translate-y-1/2';
                wisp.style.left = `${data.x}px`;
                wisp.style.top = `${data.y}px`;
                
                wisp.dataset.message = data.message || "An empty echo.";
                wisp.dataset.title = data.title || "An Echo in the Mist"; 
                wisp.dataset.author = data.userId ? data.userId.substring(0, 6) : 'unknown';

                wisp.addEventListener('mouseenter', showTooltip);
                wisp.addEventListener('mouseleave', hideTooltip);
                wisp.addEventListener('click', (e) => e.stopPropagation());

                wispContainer.appendChild(wisp);
            } catch (error) {
                console.error("Error rendering wisp:", error);
            }
        }

        /**
         * Shows the tooltip on wisp hover.
         */
        function showTooltip(event) {
            const wisp = event.target;
            const message = wisp.dataset.message;
            const author = wisp.dataset.author;
            const title = wisp.dataset.title;

            tooltip.innerHTML = `
                <p class="font-serif text-lg font-bold text-cyan-900">${title}</p>
                <p class="font-serif text-base italic my-2">"${message}"</p>
                <p class="text-xs text-gray-500 mt-2 text-right">- Traveler ${author}</p>
            `;
            
            tooltip.style.left = `${event.clientX + 15}px`;
            tooltip.style.top = `${event.clientY}px`;
            
            tooltip.classList.remove('hidden');
        }

        /**
         * Hides the tooltip.
         */
        function hideTooltip() {
            tooltip.classList.add('hidden');
        }

        /**
         * Opens the modal to leave an echo.
         */
        function openModal(e) {
            if (e.target.closest('#modal-content') || e.target.closest('#wisp-container div')) {
                return;
            }
            const rect = appContainer.getBoundingClientRect();
            tempCoords.x = e.clientX - rect.left;
            tempCoords.y = e.clientY - rect.top;

            echoTextarea.value = '';
            modal.classList.remove('hidden');
            echoTextarea.focus();
        }

        /**
         * Closes the echo modal.
         */
        function closeModal() {
            modal.classList.add('hidden');
        }

        /**
         * Submits the new echo to Firestore.
         */
        async function submitEcho() {
            const message = echoTextarea.value.trim();
            
            if (!message) {
                showMessage("Your echo cannot be empty.", true);
                return;
            }
            if (!currentUserId || !echoesRef) {
                showMessage("Not connected. Please try again.", true);
                return;
            }

            submitEchoBtn.disabled = true;
            submitEchoBtn.textContent = 'Curating...';

            try {
                const generatedTitle = await generateTitle(message);

                await addDoc(echoesRef, {
                    x: tempCoords.x,
                    y: tempCoords.y,
                    message: message,
                    title: generatedTitle, 
                    userId: currentUserId,
                    timestamp: serverTimestamp()
                });
                
                closeModal();
                showMessage("Your echo has been curated.", false);

            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage("Could not leave your echo. Please try again.", true);
            } finally {
                submitEchoBtn.disabled = false;
                submitEchoBtn.textContent = 'Leave Mark';
            }
        }

        /**
         * Attaches the real-time listener for echoes.
         */
        function attachEchoesListener() {
            if (!echoesRef) return;
            
            if (unsubscribeEchoes) {
                unsubscribeEchoes();
            }

            const q = query(echoesRef);
            unsubscribeEchoes = onSnapshot(q, (snapshot) => {
                wispContainer.innerHTML = '';
                snapshot.forEach(renderEcho);
            }, (error) => {
                console.error("Error with snapshot listener: ", error);
                showMessage("Lost connection to the echoes...", true);
            });
        }


        /**
         * Main function to initialize the app
         */
        async function main() {
            if (!firebaseConfig.apiKey) {
                showMessage("Firebase configuration is missing. This is unexpected.", true);
                return;
            }

            try {
                // Initialize Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                analytics = getAnalytics(app); // Initialize Analytics
                setLogLevel('debug'); 

                // *** THIS IS THE CRITICAL FIX ***
                // Instead of the complex "artifacts" path, we'll use a simple root collection.
                echoesCollectionPath = `guestbook-echoes`;
                echoesRef = collection(db, echoesCollectionPath);
                
                // Listen for Auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = `Traveler ID: ${currentUserId}`;
                        attachEchoesListener();
                    } else {
                        currentUserId = null;
                        userIdDisplay.textContent = 'Connecting...';
                        if ( unsubscribeEchoes) {
                            unsubscribeEchoes(); 
                        }
                    }
                });

                // Sign in anonymously for this public app
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");


                // --- GLOBAL EVENT LISTENERS ---
                
                appContainer.addEventListener('click', openModal);
                closeModalBtn.addEventListener('click', closeModal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
                
                submitEchoBtn.addEventListener('click', submitEcho);

                openArtistStatementBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    artistStatementModal.classList.remove('hidden');
                });

                closeArtistStatementBtn.addEventListener('click', () => {
                    artistStatementModal.classList.add('hidden');
                });

                artistStatementModal.addEventListener('click', (e) => {
                    if (e.target === artistStatementModal) {
                        artistStatementModal.classList.add('hidden');
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage("Failed to initialize the art space. Check console.", true);
            }
        }

        // Run the app
        main();

    </script>
</body>
</html>